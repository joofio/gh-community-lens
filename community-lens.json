{
  "resourceType": "Library",
  "id": "community-lens",
  "meta": {
    "profile": [
      "http://hl7.eu/fhir/ig/gravitate-health/StructureDefinition/lens"
    ]
  },
  "type": {
    "coding": [
      {
        "code": "logical-library"
      }
    ]
  },
  "extension": [
    {
      "url": "http://hl7.eu/fhir/ig/gravitate-health/StructureDefinition/lee-version",
      "valueString": "dev"
    }
  ],
  "url": "http://hl7.eu/fhir/ig/gravitate-health/Library/588",
  "identifier": [
    {
      "system": "http://gravitate-health.lst.tfo.upm.es",
      "value": "community-lens"
    }
  ],
  "version": "0.0.1",
  "name": "Community Finder lens",
  "_name": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente para la diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente para a diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Linse til diabetes"
          }
        ]
      }
    ]
  },
  "title": "community-lens",
  "_title": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente para la diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente para a diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Linse til diabetes"
          }
        ]
      }
    ]
  },
  "status": "draft",
  "experimental": true,
  "date": "2024-06-12T12:23:10.005Z",
  "publisher": "Gravitate Health Project - UPM Team",
  "contact": [
    {
      "name": "Gravitate Health",
      "telecom": [
        {
          "system": "url",
          "value": "https://www.gravitatehealth.eu/"
        }
      ]
    }
  ],
  "description": "Lens that highlight diabetes related information",
  "_description": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Lente que resalta informaci\u00f3n relacionada con la diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Lente que destaca informa\u00e7\u00f5es relacionadas com a diabetes"
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Linse der fremh\u00e6ver diabetesrelaterede oplysninger"
          }
        ]
      }
    ]
  },
  "jurisdiction": [
    {
      "coding": [
        {
          "code": "EU",
          "system": "urn:iso:std:iso:3166"
        }
      ]
    }
  ],
  "purpose": "Highlight diabetes related information in a preprocessed ePI.",
  "_purpose": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Resaltar informaci\u00f3n relacionada con la diabetes en una ePI preprocesada."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Destacar informa\u00e7\u00f5es relacionadas com a diabetes em uma ePI pr\u00e9-processada."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Fremh\u00e6v diabetesrelaterede oplysninger i en forbehandlet ePI."
          }
        ]
      }
    ]
  },
  "usage": "You can import this lens directly to your FHIR Server which suports Library Resource type.",
  "_usage": {
    "extension": [
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "es"
          },
          {
            "url": "content",
            "valueString": "Puedes importar esta lente directamente a tu servidor FHIR que soporte el tipo de recurso Library."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "pt"
          },
          {
            "url": "content",
            "valueString": "Podes importar esta lente diretamente para o teu servidor FHIR que suporte o tipo de recurso Library."
          }
        ]
      },
      {
        "url": "http://hl7.org/fhir/StructureDefinition/translation",
        "extension": [
          {
            "url": "lang",
            "valueCode": "da"
          },
          {
            "url": "content",
            "valueString": "Du kan importere denne linse direkte til din FHIR-server, som underst\u00f8tter ressource-typen Library."
          }
        ]
      }
    ]
  },
  "copyright": "\u00a9 2024 Gravitate Health",
  "parameter": [
    {
      "use": "in",
      "documentation": "parameter if it exists",
      "type": "CodeableConcept"
    }
  ],
  "content": [
    {
      "contentType": "application/javascript",
      "title": "Lens for diabetes",
      "data": "CmxldCBwdkRhdGEgPSBwdgpsZXQgaHRtbERhdGEgPSBodG1sCgpsZXQgZXBpRGF0YSA9IGVwaTsKbGV0IGlwc0RhdGEgPSBpcHM7CgpsZXQgZ2V0U3BlY2lmaWNhdGlvbiA9ICgpID0+IHsKICAgIHJldHVybiAiMS4wLjAiCn0KCmxldCBhbm5vdGF0aW9uUHJvY2VzcyA9IChsaXN0T2ZDYXRlZ29yaWVzLCBlbmhhbmNlVGFnLCBkb2N1bWVudCwgcmVzcG9uc2UpID0+IHsKICAgIGxpc3RPZkNhdGVnb3JpZXMuZm9yRWFjaCgoY2hlY2spID0+IHsKICAgICAgICBpZiAocmVzcG9uc2UuaW5jbHVkZXMoY2hlY2spKSB7CiAgICAgICAgICAgIGxldCBlbGVtZW50cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2hlY2spOwogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBlbGVtZW50c1tpXS5jbGFzc0xpc3QuYWRkKGVuaGFuY2VUYWcpOwogICAgICAgICAgICAgICAgZWxlbWVudHNbaV0uY2xhc3NMaXN0LmFkZCgiZGlhYmV0ZXMtbGVucyIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoZWFkIilbMF0ucmVtb3ZlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IikubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdLmlubmVySFRNTDsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIHJlc3BvbnNlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5pbm5lckhUTUwpOwogICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSk7CgogICAgaWYgKHJlc3BvbnNlID09IG51bGwgfHwgcmVzcG9uc2UgPT0gIiIpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoCiAgICAgICAgICAgICJBbm5vdGF0aW9uIHByb2NjZXNzIGZhaWxlZDogUmV0dXJuZWQgZW1wdHkgb3IgbnVsbCByZXNwb25zZSIKICAgICAgICApOwogICAgICAgIC8vcmV0dXJuIGh0bWxEYXRhCiAgICB9IGVsc2UgewogICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIHJlc3BvbnNlKTsKICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICB9Cn0KCmxldCBhbm5vdGF0ZUhUTUxzZWN0aW9uID0gYXN5bmMgKGxpc3RPZkNhdGVnb3JpZXMsIGVuaGFuY2VUYWcpID0+IHsKICAgIGxldCByZXNwb25zZSA9IGh0bWxEYXRhOwogICAgbGV0IGRvY3VtZW50OwoKICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgICAgIGxldCBqc2RvbSA9IGF3YWl0IGltcG9ydCgianNkb20iKTsKICAgICAgICBsZXQgeyBKU0RPTSB9ID0ganNkb207CiAgICAgICAgbGV0IGRvbSA9IG5ldyBKU0RPTShodG1sRGF0YSk7CiAgICAgICAgZG9jdW1lbnQgPSBkb20ud2luZG93LmRvY3VtZW50OwogICAgICAgIHJldHVybiBhbm5vdGF0aW9uUHJvY2VzcyhsaXN0T2ZDYXRlZ29yaWVzLCBlbmhhbmNlVGFnLCBkb2N1bWVudCwgcmVzcG9uc2UpOwogICAgfSBlbHNlIHsKICAgICAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsKICAgICAgICByZXR1cm4gYW5ub3RhdGlvblByb2Nlc3MobGlzdE9mQ2F0ZWdvcmllcywgZW5oYW5jZVRhZywgZG9jdW1lbnQsIHJlc3BvbnNlKTsKICAgIH0KfTsKCmxldCBlbmhhbmNlID0gYXN5bmMgKCkgPT4gewogICAgbGV0IGxpc3RPZkNhdGVnb3JpZXNUb1NlYXJjaCA9IFsiY29udHJhLWluZGljYXRpb24tZGlhYmV0ZXMtbWVsbGl0dXMiXQoKICAgIC8vSVBTIGludGVyYWN0aW9uIG5vdCBpbXBsZW1lbnRlZCB5ZXQKCiAgICAvL0dldCBjb25kaXRpb24gY2F0ZWdvcmllcyBmb3IgdGhlIGVQSSBhbmQgZmlsdGVycyBieSB0aGUgY29uZGl0aW9uIHdlIHdhbnQgdG8gY2hlY2sKICAgIGxldCBjYXRlZ29yaWVzID0gW10KICAgIGVwaS5lbnRyeS5mb3JFYWNoKGVsZW1lbnQgPT4gewogICAgICAgIGlmIChlbGVtZW50LnJlc291cmNlLmV4dGVuc2lvbiAhPSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgZWxlbWVudC5yZXNvdXJjZS5leHRlbnNpb24uZm9yRWFjaChjYXRlZ29yeSA9PiB7CiAgICAgICAgICAgICAgICBpZiAobGlzdE9mQ2F0ZWdvcmllc1RvU2VhcmNoLmluY2x1ZGVzKGNhdGVnb3J5LmV4dGVuc2lvblswXS52YWx1ZVN0cmluZykpIHsKICAgICAgICAgICAgICAgICAgICBjYXRlZ29yaWVzLnB1c2goY2F0ZWdvcnkuZXh0ZW5zaW9uWzBdLnZhbHVlU3RyaW5nKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9KTsKCiAgICAvL0ZvY3VzIChhZGRzIGhpZ2hsaWdodCBjbGFzcykgdGhlIGh0bWwgYXBwbHlpbmcgZXZlcnkgY2F0ZWdvcnkgZm91bmQKCiAgICBpZiAoY2F0ZWdvcmllcy5sZW5ndGggPT0gMCkgewogICAgICAgIC8vIHRocm93IG5ldyBFcnJvcigiTm8gY2F0ZWdvcmllcyBmb3VuZCIsIGNhdGVnb3JpZXMpOwogICAgICAgIHJldHVybiBodG1sRGF0YQogICAgfQogICAgLy9Gb2N1cyAoYWRkcyBoaWdobGlnaHQgY2xhc3MpIHRoZSBodG1sIGFwcGx5aW5nIGV2ZXJ5IGNhdGVnb3J5IGZvdW5kCiAgICByZXR1cm4gYXdhaXQgYW5ub3RhdGVIVE1Mc2VjdGlvbihjYXRlZ29yaWVzLCAiaGlnaGxpZ2h0Iik7Cn0KcmV0dXJuIHsKICAgIGVuaGFuY2U6IGVuaGFuY2UsCiAgICBnZXRTcGVjaWZpY2F0aW9uOiBnZXRTcGVjaWZpY2F0aW9uCn0=",
      "_title": {
        "extension": [
          {
            "url": "http://hl7.org/fhir/StructureDefinition/translation",
            "extension": [
              {
                "url": "lang",
                "valueCode": "es"
              },
              {
                "url": "content",
                "valueString": "Lente para la diabetes"
              }
            ]
          },
          {
            "url": "http://hl7.org/fhir/StructureDefinition/translation",
            "extension": [
              {
                "url": "lang",
                "valueCode": "pt"
              },
              {
                "url": "content",
                "valueString": "Lente para a diabetes"
              }
            ]
          },
          {
            "url": "http://hl7.org/fhir/StructureDefinition/translation",
            "extension": [
              {
                "url": "lang",
                "valueCode": "da"
              },
              {
                "url": "content",
                "valueString": "Linse til diabetes"
              }
            ]
          }
        ]
      }
    }
  ],
  "data": "bGV0IHB2RGF0YSA9IHB2OwpsZXQgaHRtbERhdGEgPSBodG1sOwoKbGV0IGVwaURhdGEgPSBlcGk7CmxldCBpcHNEYXRhID0gaXBzOwoKbGV0IGdldFNwZWNpZmljYXRpb24gPSAoKSA9PiB7CiAgICByZXR1cm4gIjIuMC4zLWNvbW11bml0eS1iYW5uZXIiOwp9OwovL2RvY3VtZW50LCBodG1sRGF0YSwgYmFubmVySFRNTAovLwpjb25zdCBpbnNlcnRDb250YWN0TGlua3MgPSAobGlzdE9mQ2F0ZWdvcmllcywgY29udGFjdHMsIGRvY3VtZW50LCByZXNwb25zZSkgPT4gewogICAgbGlzdE9mQ2F0ZWdvcmllcy5mb3JFYWNoKChjbGFzc05hbWUpID0+IHsKICAgICAgICBpZiAoCiAgICAgICAgICAgIHJlc3BvbnNlLmluY2x1ZGVzKGBjbGFzcz0iJHtjbGFzc05hbWV9YCkgfHwKICAgICAgICAgICAgcmVzcG9uc2UuaW5jbHVkZXMoYGNsYXNzPScke2NsYXNzTmFtZX1gKQogICAgICAgICkgewogICAgICAgICAgICBjb25zdCBlbGVtZW50cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoY2xhc3NOYW1lKTsKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgY29uc3QgZWwgPSBlbGVtZW50c1tpXTsKCiAgICAgICAgICAgICAgICBjb250YWN0cy5mb3JFYWNoKGNvbnRhY3QgPT4gewogICAgICAgICAgICAgICAgICAgIGxldCBocmVmID0gIiI7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbnRhY3QudHlwZSA9PT0gImVtYWlsIikgewogICAgICAgICAgICAgICAgICAgICAgICBocmVmID0gYG1haWx0bzoke2NvbnRhY3QudmFsdWV9YDsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRhY3QudHlwZSA9PT0gInBob25lIikgewogICAgICAgICAgICAgICAgICAgICAgICBocmVmID0gYHRlbDoke2NvbnRhY3QudmFsdWV9YDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGlmIChocmVmKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSA8YT4gYW5kIHdyYXAgZXhpc3RpbmcgY29udGVudAogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYSIpOwogICAgICAgICAgICAgICAgICAgICAgICBhLnNldEF0dHJpYnV0ZSgiaHJlZiIsIGhyZWYpOwogICAgICAgICAgICAgICAgICAgICAgICBhLnNldEF0dHJpYnV0ZSgidGFyZ2V0IiwgIl9ibGFuayIpOwogICAgICAgICAgICAgICAgICAgICAgICBhLmNsYXNzTGlzdC5hZGQoImNvbW11bml0eS1sZW5zIik7CgogICAgICAgICAgICAgICAgICAgICAgICBhLmlubmVySFRNTCA9IGVsLmlubmVySFRNTDsgIC8vIG1vdmUgb3JpZ2luYWwgY29udGVudCBpbnRvIDxhPgogICAgICAgICAgICAgICAgICAgICAgICBlbC5pbm5lckhUTUwgPSAiIjsgICAgICAgICAgIC8vIGNsZWFyIG9yaWdpbmFsIGNvbnRlbnQKICAgICAgICAgICAgICAgICAgICAgICAgZWwuYXBwZW5kQ2hpbGQoYSk7ICAgICAgICAgICAvLyBpbnNlcnQgdGhlIDxhPiBpbnNpZGUgdGhlIG9yaWdpbmFsIGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0pCgoKICAgIC8vIENsZWFuIGhlYWQgKHNhbWUgYXMgeW91ciBvcmlnaW5hbCBsb2dpYykKICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpLmxlbmd0aCA+IDApIHsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaGVhZCIpWzBdLnJlbW92ZSgpOwogICAgfQoKICAgIC8vIEV4dHJhY3QgSFRNTCByZXN1bHQKICAgIGlmIChkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpLmxlbmd0aCA+IDApIHsKICAgICAgICByZXNwb25zZSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uaW5uZXJIVE1MOwogICAgICAgIGNvbnNvbGUubG9nKCJSZXNwb25zZTogIiArIHJlc3BvbnNlKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc29sZS5sb2coIlJlc3BvbnNlOiAiICsgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmlubmVySFRNTCk7CiAgICAgICAgcmVzcG9uc2UgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuaW5uZXJIVE1MOwogICAgfQoKICAgIGlmICghcmVzcG9uc2UgfHwgcmVzcG9uc2UudHJpbSgpID09PSAiIikgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiQW5ub3RhdGlvbiBwcm9jZXNzIGZhaWxlZDogZW1wdHkgb3IgbnVsbCByZXNwb25zZSIpOwogICAgfQoKICAgIHJldHVybiByZXNwb25zZTsKfTsKCmxldCBlbmhhbmNlID0gYXN5bmMgKCkgPT4gewogICAgaWYgKCFpcHNEYXRhIHx8ICFpcHNEYXRhLmVudHJ5IHx8IGlwc0RhdGEuZW50cnkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJJUFMgaXMgZW1wdHkgb3IgaW52YWxpZC4iKTsKICAgIH0KICAgIGlmICghZXBpRGF0YSB8fCAhZXBpRGF0YS5lbnRyeSB8fCBlcGlEYXRhLmVudHJ5Lmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiZVBJIGlzIGVtcHR5IG9yIGludmFsaWQuIik7CiAgICB9CgoKICAgIGxldCBhcnJheU9mQ2xhc3NlcyA9IFt7ICJjb2RlIjogImdyYXYtNCIsICJzeXN0ZW0iOiAiaHR0cHM6Ly93d3cuZ3Jhdml0YXRlaGVhbHRoLmV1L3NpZC9kb2MiIH1dICAgICAgLy93aGF0IHRvIGxvb2sgaW4gZXh0ZW5zaW9ucyAtbWFkZSB1cCBjb2RlIGJlY2F1c2UgdGhlcmUgaXMgbm9uZQoKICAgIGNvbnN0IGNvbnRhY3RzID0gW107IC8vIFRoaXMgd2lsbCBzdG9yZSB0aGUgY29sbGVjdGVkIGNvbnRhY3QgaW5mbwoKICAgIGZvciAoY29uc3QgZW50cnkgb2YgaXBzRGF0YS5lbnRyeSkgewogICAgICAgIGNvbnN0IHJlcyA9IGVudHJ5LnJlc291cmNlOwogICAgICAgIGlmICghcmVzIHx8IHJlcy5yZXNvdXJjZVR5cGUgIT09ICJQYXRpZW50IikgY29udGludWU7CgogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHJlcy5nZW5lcmFsUHJhY3RpdGlvbmVyKSkgewogICAgICAgICAgICBmb3IgKGNvbnN0IGdwUmVmIG9mIHJlcy5nZW5lcmFsUHJhY3RpdGlvbmVyKSB7CiAgICAgICAgICAgICAgICBjb25zdCBncElkID0gZ3BSZWYucmVmZXJlbmNlPy5zcGxpdCgiLyIpWzFdOwogICAgICAgICAgICAgICAgaWYgKCFncElkKSBjb250aW51ZTsKCiAgICAgICAgICAgICAgICBjb25zdCBncFJlc291cmNlID0gaXBzRGF0YS5lbnRyeS5maW5kKGUgPT4gZS5yZXNvdXJjZT8uaWQgPT09IGdwSWQpPy5yZXNvdXJjZTsKICAgICAgICAgICAgICAgIGlmICghZ3BSZXNvdXJjZSkgY29udGludWU7CgogICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgIGdwUmVzb3VyY2UucmVzb3VyY2VUeXBlID09PSAiUHJhY3RpdGlvbmVyIiB8fAogICAgICAgICAgICAgICAgICAgIGdwUmVzb3VyY2UucmVzb3VyY2VUeXBlID09PSAiT3JnYW5pemF0aW9uIgogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVsZWNvbXMgPSBncFJlc291cmNlLnRlbGVjb207CiAgICAgICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGVsZWNvbXMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZpbHRlcmVkID0gdGVsZWNvbXMuZmlsdGVyKHQgPT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsicGhvbmUiLCAiZW1haWwiXS5pbmNsdWRlcyh0LnN5c3RlbSkKICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCB0ZWxlY29tIG9mIGZpbHRlcmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWN0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiB0ZWxlY29tLnN5c3RlbSwgICAgICAgICAgICAgLy8gJ3Bob25lJyBvciAnZW1haWwnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHRlbGVjb20udmFsdWUsICAgICAgICAgICAgIC8vIGUuZy4gJysxMjM0NTY3ODknCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VUeXBlOiBncFJlc291cmNlLnJlc291cmNlVHlwZSwgLy8gJ1ByYWN0aXRpb25lcicgb3IgJ09yZ2FuaXphdGlvbicKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZDogZ3BSZXNvdXJjZS5pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgLy8gRXhhbXBsZSB1c2FnZToKICAgIGNvbnNvbGUubG9nKCJDb2xsZWN0ZWQgY29udGFjdHM6IiwgY29udGFjdHMpOwoKCiAgICAvLyBlUEkgdHJhc2xhdGlvbiBmcm9tIHRlcm1pbm9sb2d5IGNvZGVzIHRvIHRoZWlyIGh1bWFuIHJlZGFibGUgdHJhbnNsYXRpb25zIGluIHRoZSBzZWN0aW9ucwogICAgbGV0IGNvbXBvc2l0aW9ucyA9IDA7CiAgICBsZXQgY2F0ZWdvcmllcyA9IFtdOwoKICAgIGVwaS5lbnRyeS5mb3JFYWNoKChlbnRyeSkgPT4gewogICAgICAgIGlmIChlbnRyeS5yZXNvdXJjZS5yZXNvdXJjZVR5cGUgPT0gIkNvbXBvc2l0aW9uIikgewogICAgICAgICAgICBjb21wb3NpdGlvbnMrKzsKICAgICAgICAgICAgLy9JdGVyYXRlZCB0aHJvdWdoIHRoZSBDb25kaXRpb24gZWxlbWVudCBzZWFyY2hpbmcgZm9yIGNvbmRpdGlvbnMKICAgICAgICAgICAgZW50cnkucmVzb3VyY2UuZXh0ZW5zaW9uLmZvckVhY2goKGVsZW1lbnQpID0+IHsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgcG9zaXRpb24gb2YgdGhlIGV4dGVuc2lvblsxXSBpcyBjb3JyZWN0CiAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5leHRlbnNpb25bMV0udXJsID09ICJjb25jZXB0IikgewogICAgICAgICAgICAgICAgICAgIC8vIFNlYXJjaCB0aHJvdWdoIHRoZSBkaWZmZXJlbnQgdGVybWlub2xvZ2llcyB0aGF0IG1heSBiZSBhdmFpYmxlIHRvIGNoZWNrIGluIHRoZSBjb25kaXRpb24KICAgICAgICAgICAgICAgICAgICBpZiAoZWxlbWVudC5leHRlbnNpb25bMV0udmFsdWVDb2RlYWJsZVJlZmVyZW5jZS5jb25jZXB0ICE9IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmV4dGVuc2lvblsxXS52YWx1ZUNvZGVhYmxlUmVmZXJlbmNlLmNvbmNlcHQuY29kaW5nLmZvckVhY2goCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoY29kaW5nKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkV4dGVuc2lvbjogIiArIGVsZW1lbnQuZXh0ZW5zaW9uWzBdLnZhbHVlU3RyaW5nICsgIjoiICsgY29kaW5nLmNvZGUgKyAiIC0gIiArIGNvZGluZy5zeXN0ZW0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGNvZGUgaXMgaW4gdGhlIGxpc3Qgb2YgY2F0ZWdvcmllcyB0byBzZWFyY2gKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFycmF5T2ZDbGFzc2VzLnNvbWUoaXRlbSA9PiBpdGVtLmNvZGUgPT09IGNvZGluZy5jb2RlICYmIGl0ZW0uc3lzdGVtID09PSBjb2Rpbmcuc3lzdGVtKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayBpZiB0aGUgY2F0ZWdvcnkgaXMgYWxyZWFkeSBpbiB0aGUgbGlzdCBvZiBjYXRlZ29yaWVzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJGb3VuZCIsIGVsZW1lbnQuZXh0ZW5zaW9uWzBdLnZhbHVlU3RyaW5nKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXRlZ29yaWVzLnB1c2goZWxlbWVudC5leHRlbnNpb25bMF0udmFsdWVTdHJpbmcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0pOwoKCiAgICBpZiAoY29tcG9zaXRpb25zID09IDApIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0JhZCBlUEk6IG5vIGNhdGVnb3J5ICJDb21wb3NpdGlvbiIgZm91bmQnKTsKICAgIH0KICAgIGlmIChjYXRlZ29yaWVzLmxlbmd0aCA9PSAwKSB7CiAgICAvLyB0aHJvdyBuZXcgRXJyb3IoIk5vIGNhdGVnb3JpZXMgZm91bmQiLCBjYXRlZ29yaWVzKTsKICAgIHJldHVybiBodG1sRGF0YTsKICB9CgogICAgZWxzZSB7CgoKICAgICAgICBsZXQgcmVzcG9uc2UgPSBodG1sRGF0YTsKICAgICAgICBsZXQgZG9jdW1lbnQ7CgogICAgICAgIGlmICh0eXBlb2Ygd2luZG93ID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICBsZXQganNkb20gPSBhd2FpdCBpbXBvcnQoImpzZG9tIik7CiAgICAgICAgICAgIGxldCB7IEpTRE9NIH0gPSBqc2RvbTsKICAgICAgICAgICAgbGV0IGRvbSA9IG5ldyBKU0RPTShodG1sRGF0YSk7CiAgICAgICAgICAgIGRvY3VtZW50ID0gZG9tLndpbmRvdy5kb2N1bWVudDsKICAgICAgICAgICAgcmV0dXJuIGluc2VydENvbnRhY3RMaW5rcyhjYXRlZ29yaWVzLCBjb250YWN0cywgZG9jdW1lbnQsIHJlc3BvbnNlKTsKICAgICAgICAgICAgLy9saXN0T2ZDYXRlZ29yaWVzLCBlbmhhbmNlVGFnLCBkb2N1bWVudCwgcmVzcG9uc2UKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudDsKICAgICAgICAgICAgcmV0dXJuIGluc2VydENvbnRhY3RMaW5rcyhjYXRlZ29yaWVzLCBjb250YWN0cywgZG9jdW1lbnQsIHJlc3BvbnNlKTsKICAgICAgICB9CiAgICB9Owp9OwoKcmV0dXJuIHsKICAgIGVuaGFuY2U6IGVuaGFuY2UsCiAgICBnZXRTcGVjaWZpY2F0aW9uOiBnZXRTcGVjaWZpY2F0aW9uLAp9Owo="
}